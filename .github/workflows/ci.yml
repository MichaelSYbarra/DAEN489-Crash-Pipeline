name: "CI Pipeline"

on:
  push:
    branches: ["*"]

jobs:
  build:
    name: "Build and Validate"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Set up Go"
        uses: actions/setup-go@v4
        with:
          go-version: "1.22"

      - name: "Build Go extractor"
        working-directory: ./extractor
        run: |
          go mod tidy
          go build ./...

      - name: "Set up Python"
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: "Install Python dependencies"
        run: |
          pip install --upgrade pip
          pip install -r requirments.txt

      - name: "Test Python imports"
        run: |
          python -c "import sys; import os; print('Python imports OK')"

  docker-validation:
    name: "Docker Compose Validation"
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Setup environment file"
        run: |
            cp .env.sample .env

      - name: "Build key services with docker compose"
        run: |
          docker compose -f docker-compose.yaml build extractor
          docker compose -f docker-compose.yaml build transformer
          docker compose -f docker-compose.yaml build cleaner
          docker compose -f docker-compose.yaml build streamlit

      - name: "Validate docker-compose.yaml"
        run: |
          docker compose -f docker-compose.yaml config

  sanity-check:
    name: "Sanity Check Entrypoints"
    runs-on: ubuntu-latest
    needs: docker-validation

    steps:
        - name: "Checkout repository"
          uses: actions/checkout@v4

        # Start all required services in the background
        - name: "Start key Docker services"
          run: |
            docker compose -f docker-compose.yaml up -d minio extractor transformer cleaner

        # Extractor help check inside Docker network
        - name: "Extractor help check"
          run: |
            docker compose -f docker-compose.yaml run --rm extractor go run main.go --help

        # Transformer import check
        - name: "Transformer import test"
          run: |
            python - <<EOF
            import transformer
            print("Transformer imported successfully")
            EOF

        # Cleaner import check
        - name: "Cleaner import test"
          run: |
            python - <<EOF
            import cleaner
            print("Cleaner imported successfully")
            EOF

        # Stop services after sanity checks
        - name: "Stop Docker services"
          run: |
            docker compose -f docker-compose.yml down
